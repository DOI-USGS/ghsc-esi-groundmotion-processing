<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="gmprocess" href="../apidoc/gmprocess.html" /><link rel="prev" title="Code layout" href="code-layout.html" />

    <meta name="generator" content="sphinx-3.4.0, furo 2020.12.28.beta22"/>
        <title>Adding a new data reader - gmprocess 1.0.4 documentation</title>
      <link rel="stylesheet" href="../_static/styles/furo.css?digest=d315feae89b83a5365ff3ccc3644a1018972e3a0">
    <link rel="stylesheet" href="../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link rel="stylesheet" href="../_static/styles/furo-extensions.css?digest=26485485040e7aaf717c13fd0188a5ad2c2deb60">
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script defer="defer" src="../_static/jquery.js"></script>
    <script defer="defer" src="../_static/underscore.js"></script>
    <script defer="defer" src="../_static/doctools.js"></script>
    <script defer src="../_static/scripts/main.js?digest=e931d09b2a40c1bb82b542effe772014573baf67"></script></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">gmprocess 1.0.4 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/gmprocess_logo.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Objective</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html#motivation">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html#target-use-cases">Target Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/workspace.html">Workspace</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/running.html">Running the code</a></li>
</ul>
<p class="caption"><span class="caption-text">Processing Steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../processing-steps/reading.html">Reading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../processing-steps/retrieve.html">Retrieving data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../processing-steps/windowing.html">Windowing data</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../processing-steps/index.html">Waveform processing</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../processing-steps/waveform-processing.html">Waveform Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-steps/waveform-processing/initial-qc.html">Initial quality control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-steps/waveform-processing/remove-response.html">Removing instrument response</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-steps/waveform-processing/phase-pickers.html">Phase pickers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-steps/waveform-processing/baseline-correction.html">Baseline correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing-steps/waveform-processing/filtering.html">Filtering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../processing-steps/data-units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../processing-steps/waveform-metrics.html">Waveform metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../processing-steps/station-metrics.html">Station metrics</a></li>
</ul>
<p class="caption"><span class="caption-text">Using gmprocess</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gmprocess/gmprocess.html">The gmprocess command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gmprocess/reading.html">Reading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gmprocess/waveform-processing.html">Waveform processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gmprocess/reports.html">Processing reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gmprocess/exporting.html">Exporting data</a></li>
</ul>
<p class="caption"><span class="caption-text">Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../utilities/gmworkspace.html">The gmworkspace command</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/gmconvert.html">Converting data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/matlab.html">Matlab utilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Python Scripting</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../scripting/index.html">Data structures</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../scripting/data-structures.html">Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scripting/data-structures/station-trace.html">StationTrace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scripting/data-structures/station-stream.html">StationStream</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scripting/data-structures/stream-collection.html">StreamCollection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../scripting/scripting.html">Writing Python scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scripting/waveform-metrics.html">Waveform metrics</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="code-layout.html">Code layout</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Adding new data readers</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../apidoc/gmprocess.html">API</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apidoc/gmprocess.core.html">gmprocess.core</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.core.stationstream.html">gmprocess.core.stationstream</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.core.stationtrace.html">gmprocess.core.stationtrace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.core.streamcollection.html">gmprocess.core.streamcollection</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apidoc/gmprocess.io.html">gmprocess.io</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label for="toctree-checkbox-5"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.catalog.html">gmprocess.io.catalog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.fetcher.html">gmprocess.io.fetcher</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.global_fetcher.html">gmprocess.io.global_fetcher</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.nga.html">gmprocess.io.nga</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.read.html">gmprocess.io.read</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.read_directory.html">gmprocess.io.read_directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.report.html">gmprocess.io.report</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.seedname.html">gmprocess.io.seedname</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.stream.html">gmprocess.io.stream</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.io.utils.html">gmprocess.io.utils</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apidoc/gmprocess.utils.html">gmprocess.utils</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label for="toctree-checkbox-6"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.args.html">gmprocess.utils.args</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.config.html">gmprocess.utils.config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.event.html">gmprocess.utils.event</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.exception.html">gmprocess.utils.exception</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.logging.html">gmprocess.utils.logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.models.html">gmprocess.utils.models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.plot.html">gmprocess.utils.plot</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.utils.tables.html">gmprocess.utils.tables</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.html">gmprocess.waveform_processing</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label for="toctree-checkbox-7"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.adjust_highpass.html">gmprocess.waveform_processing.adjust_highpass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.corner_frequencies.html">gmprocess.waveform_processing.corner_frequencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.fft.html">gmprocess.waveform_processing.fft</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.filtering.html">gmprocess.waveform_processing.filtering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.nn_quality_assurance.html">gmprocess.waveform_processing.nn_quality_assurance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.phase.html">gmprocess.waveform_processing.phase</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.pretesting.html">gmprocess.waveform_processing.pretesting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.processing.html">gmprocess.waveform_processing.processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.snr.html">gmprocess.waveform_processing.snr</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.spectrum.html">gmprocess.waveform_processing.spectrum</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.windows.html">gmprocess.waveform_processing.windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apidoc/gmprocess.waveform_processing.zero_crossings.html">gmprocess.waveform_processing.zero_crossings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="adding-a-new-data-reader">
<h1>Adding a new data reader<a class="headerlink" href="#adding-a-new-data-reader" title="Permalink to this headline">¶</a></h1>
<p>Most of the difficulty in writing data file readers for the various formats
supported by gmprocess comes in handling the various types of headers and
inconsistencies in adherence to the various standards. Here we’ll be removing
those from the equation and presenting a semi-idealized data format and some
code to read it.</p>
<div class="section" id="the-format">
<h2>The Format<a class="headerlink" href="#the-format" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Source</span><span class="p">:</span> <span class="n">Complete</span> <span class="n">Strong</span> <span class="n">Motion</span> <span class="n">Network</span>
<span class="n">Network</span><span class="p">:</span> <span class="n">CS</span>
<span class="n">Station</span><span class="p">:</span> <span class="n">ABCD</span>
<span class="n">Station</span> <span class="n">Latitude</span><span class="p">:</span> <span class="mf">32.443343</span>
<span class="n">Station</span> <span class="n">Longitude</span><span class="p">:</span> <span class="o">-</span><span class="mf">127.753918</span>
<span class="n">Station</span> <span class="n">Elevation</span> <span class="p">(</span><span class="n">m</span><span class="p">):</span> <span class="mf">10.0</span>
<span class="n">Instrument</span><span class="p">:</span> <span class="n">Acme</span> <span class="n">Strong</span> <span class="n">Motion</span> <span class="n">Sensor</span>
<span class="n">Serial</span> <span class="n">Number</span><span class="p">:</span> <span class="mi">123456</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">cm</span><span class="o">/</span><span class="n">s</span><span class="o">^</span><span class="mi">2</span>
<span class="n">Structure</span> <span class="n">Type</span><span class="p">:</span> <span class="n">Free</span> <span class="n">field</span> <span class="n">sensor</span>
<span class="n">Channel</span> <span class="mi">1</span> <span class="n">Horizontal</span> <span class="n">Orientation</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Channel</span> <span class="mi">2</span> <span class="n">Horizontal</span> <span class="n">Orientation</span><span class="p">:</span> <span class="mi">90</span>
<span class="n">Channel</span> <span class="mi">3</span> <span class="n">Horizontal</span> <span class="n">Orientation</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Vertical</span> <span class="n">Channel</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">Samples</span><span class="p">:</span> <span class="mi">10</span>
<span class="n">Record</span> <span class="n">Start</span> <span class="n">Time</span><span class="p">:</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span> <span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mf">56.010</span>
<span class="n">Sampling</span> <span class="n">Rate</span> <span class="p">(</span><span class="n">Hz</span><span class="p">):</span> <span class="mi">100</span>
     <span class="mf">0.001</span>     <span class="mf">0.011</span>     <span class="mf">0.021</span>
     <span class="mf">0.002</span>     <span class="mf">0.012</span>     <span class="mf">0.022</span>
     <span class="mf">0.003</span>     <span class="mf">0.013</span>     <span class="mf">0.023</span>
     <span class="mf">0.004</span>     <span class="mf">0.014</span>     <span class="mf">0.024</span>
     <span class="mf">0.005</span>     <span class="mf">0.015</span>     <span class="mf">0.025</span>
     <span class="mf">0.006</span>     <span class="mf">0.016</span>     <span class="mf">0.026</span>
     <span class="mf">0.007</span>     <span class="mf">0.017</span>     <span class="mf">0.027</span>
     <span class="mf">0.008</span>     <span class="mf">0.018</span>     <span class="mf">0.028</span>
     <span class="mf">0.009</span>     <span class="mf">0.019</span>     <span class="mf">0.029</span>
     <span class="mf">0.010</span>     <span class="mf">0.020</span>     <span class="mf">0.030</span>
</pre></div>
</div>
</div>
<div class="section" id="the-code">
<h2>The Code<a class="headerlink" href="#the-code" title="Permalink to this headline">¶</a></h2>
<p>The sample module below has been tested with the above data, and can be used as
a template for writing a data reader for a new format. This data format is (as
it’s name implies) complete in terms of the information required to construct a
StationStream object. Real-world formats may not be as complete - the bare minimum
information needed to construct a StationStream of minimal use includes:</p>
<ul class="simple">
<li><p>Station code</p></li>
<li><p>Station horizontal coordinates</p></li>
<li><p>Some indication of the input units</p></li>
<li><p>Sampling rate or sampling interval</p></li>
<li><p>Distinction between horizontal and vertical channels</p></li>
<li><p>Either a channel orientation (0-360) or some indication of what is E-W and N-S</p></li>
</ul>
<p>Record start time is <em>strongly</em> desired, but a “NaN” record start time value of
1970-01-01 00:00:00 will be inserted by Obspy if not supplied.</p>
<p>The code below contains comments that should be useful as guides when writing
your own reader. A finished reader with tests and data should be organized as below:</p>
<p>Assumptions: The event ID associated with this record is <strong>csabcd1234</strong>.</p>
<ul class="simple">
<li><p>gmprocess-&gt;io-&gt;complete-&gt;core.py (the code below)</p></li>
<li><p>tests-&gt;gmprocess-&gt;io-&gt;complete-&gt;complete_test.py (test code for core.py)</p></li>
<li><p>gmprocess-&gt;data-&gt;testdata-&gt;complete-&gt;csabcd1234-&gt;complete.dat (at least one example of the file format)</p></li>
</ul>
<p>AND</p>
<ul class="simple">
<li><p>gmprocess-&gt;data-&gt;testdata-&gt;complete-&gt;event.json-&gt;event.json (JSON file containing basic event information):</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"csabcd1234"</span><span class="p">,</span>
    <span class="s2">"time"</span><span class="p">:</span> <span class="s2">"2019-05-01T12:34:55.010"</span><span class="p">,</span>
    <span class="s2">"lat"</span><span class="p">:</span> <span class="mf">32.443</span><span class="p">,</span>
    <span class="s2">"lon"</span><span class="p">:</span> <span class="o">-</span><span class="mf">127.753</span><span class="p">,</span>
    <span class="s2">"depth"</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
    <span class="s2">"magnitude"</span><span class="p">:</span> <span class="mf">6.0</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># stlib imports</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="c1"># third party imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">obspy.core.utcdatetime</span> <span class="kn">import</span> <span class="n">UTCDateTime</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">gmprocess.core.stationtrace</span> <span class="kn">import</span> <span class="n">StationTrace</span>
<span class="kn">from</span> <span class="nn">gmprocess.core.stationstream</span> <span class="kn">import</span> <span class="n">StationStream</span>
<span class="kn">from</span> <span class="nn">gmprocess.io.seedname</span> <span class="kn">import</span> <span class="n">get_channel_name</span><span class="p">,</span> <span class="n">is_channel_north</span>

<span class="n">TEXT_HDR_ROWS</span> <span class="o">=</span> <span class="mi">17</span>
<span class="n">SOURCE_TYPE</span> <span class="o">=</span> <span class="s1">'Complete Strong Motion Network'</span>


<span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">'''Determine whether input file is from the Complete Strong Motion Network.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str):</span>
<span class="sd">            Input candidate Complete format file.</span>
<span class="sd">    Returns:</span>
<span class="sd">        bool:</span>
<span class="sd">            True if input file matches the Complete format, False otherwise.</span>
<span class="sd">    '''</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TEXT_HDR_ROWS</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">SOURCE_TYPE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">read_complete</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">'''Read file in the Complete file format, return a list of one StationStream.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str):</span>
<span class="sd">            Input candidate Complete format file.</span>
<span class="sd">    Returns:</span>
<span class="sd">        list: Sequence of one StationStream object.</span>
<span class="sd">    '''</span>
    <span class="c1"># it is probably a good idea to separate the reading of the</span>
    <span class="c1"># header information from the reading of the data</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">_read_header</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">_get_stats</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="c1"># Reading FORTRAN formatted fixed-width column data is simple</span>
    <span class="c1"># thanks to the numpy genfromtxt() method.</span>
    <span class="c1"># if the data is in units other than gals (c/s^2), perform</span>
    <span class="c1"># the appropriate conversion here.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="n">TEXT_HDR_ROWS</span><span class="p">)</span>

    <span class="c1"># We subclassed the Obspy Trace object to carry around</span>
    <span class="c1"># more metadata and also perform some validation.</span>
    <span class="c1"># Here we construct three traces from each of the</span>
    <span class="c1"># three columns of data and the relevant header info</span>
    <span class="n">trace1</span> <span class="o">=</span> <span class="n">_get_channel_trace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">trace2</span> <span class="o">=</span> <span class="n">_get_channel_trace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">trace3</span> <span class="o">=</span> <span class="n">_get_channel_trace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="c1"># We have also subclassed the Obspy Stream object</span>
    <span class="n">stream</span> <span class="o">=</span> <span class="n">StationStream</span><span class="p">(</span><span class="n">traces</span><span class="o">=</span><span class="p">[</span><span class="n">trace1</span><span class="p">,</span> <span class="n">trace2</span><span class="p">,</span> <span class="n">trace3</span><span class="p">])</span>

    <span class="c1"># All readers should return a list of StationStream objects, since</span>
    <span class="c1"># some formats contain records from multiple stations in one file.</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">stream</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_read_header</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># read in the text header lines, turn them into a dictionary.</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'rt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">lines_read</span> <span class="o">&lt;</span> <span class="n">TEXT_HDR_ROWS</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">header</span>


<span class="k">def</span> <span class="nf">_get_stats</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="c1"># fill in the Obspy stats dictionary with the data described here:</span>
    <span class="c1"># https://docs.obspy.org/packages/autogen/obspy.core.trace.Stats.html</span>
    <span class="c1"># Also add two sub-dictionaries, "standard" and "coordinates".</span>
    <span class="c1"># "standard" is meant to hold metadata we discovered to be common</span>
    <span class="c1"># among many formats. "coordinates" is meant to hold latitude,</span>
    <span class="c1"># longitude, and elevation of the station. In Obspy, this type of</span>
    <span class="c1"># information is commonly kept in the Inventory object:</span>
    <span class="c1">#  https://docs.obspy.org/packages/autogen/obspy.core.inventory.inventory.Inventory.html</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">'starttime'</span><span class="p">]</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">'Record Start Time'</span><span class="p">])</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">'sampling_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">'Sampling Rate (Hz)'</span><span class="p">])</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">'npts'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">'Samples'</span><span class="p">])</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">'station'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Station'</span><span class="p">]</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">'network'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Network'</span><span class="p">]</span>

    <span class="n">standard</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'source'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Source'</span><span class="p">]</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'instrument'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Instrument'</span><span class="p">]</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'sensor_serial_number'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Serial Number'</span><span class="p">]</span>
    <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'source_file'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tail</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'process_level'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'uncorrected physical units'</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'units'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'acc'</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'source_format'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'complete'</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'instrument_damping'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'structure_type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'comments'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'corner_frequency'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'instrument_period'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'station_name'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span>
    <span class="n">standard</span><span class="p">[</span><span class="s1">'process_time'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">''</span>

    <span class="n">coordinates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">coordinates</span><span class="p">[</span><span class="s1">'latitude'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Station Latitude'</span><span class="p">]</span>
    <span class="n">coordinates</span><span class="p">[</span><span class="s1">'longitude'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Station Longitude'</span><span class="p">]</span>
    <span class="n">coordinates</span><span class="p">[</span><span class="s1">'elevation'</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Station Elevation (m)'</span><span class="p">]</span>

    <span class="n">stats</span><span class="p">[</span><span class="s1">'standard'</span><span class="p">]</span> <span class="o">=</span> <span class="n">standard</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">'coordinates'</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">stats</span>


<span class="k">def</span> <span class="nf">_get_channel_trace</span><span class="p">(</span><span class="n">channel_number</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span>
                       <span class="n">stats</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Create a StationTrace object from the given channel number</span>
    <span class="c1"># and input metadata and data.</span>
    <span class="n">channel_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">orientation</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">'Channel </span><span class="si">%i</span><span class="s1"> Horizontal Orientation'</span> <span class="o">%</span> <span class="n">channel_number</span><span class="p">])</span>
    <span class="n">channel_stats</span><span class="p">[</span><span class="s1">'standard'</span><span class="p">][</span><span class="s1">'horizontal_orientation'</span><span class="p">]</span> <span class="o">=</span> <span class="n">orientation</span>
    <span class="n">is_vertical</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">'Vertical Channel'</span><span class="p">]</span> <span class="o">==</span> <span class="n">channel_number</span>
    <span class="n">is_north</span> <span class="o">=</span> <span class="n">is_channel_north</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
    <span class="n">channel_stats</span><span class="p">[</span><span class="s1">'channel'</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_channel_name</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">'sampling_rate'</span><span class="p">],</span>
                                                <span class="n">is_acceleration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">is_vertical</span><span class="o">=</span><span class="n">is_vertical</span><span class="p">,</span>
                                                <span class="n">is_north</span><span class="o">=</span><span class="n">is_north</span>
                                                <span class="p">)</span>
    <span class="n">channelidx</span> <span class="o">=</span> <span class="n">channel_number</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">StationTrace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[:,</span> <span class="n">channelidx</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="n">channel_stats</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trace</span>
</pre></div>
</div>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../apidoc/gmprocess.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">gmprocess</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="code-layout.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Code layout</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; Public Domain
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../_sources/developer/readers.md.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Adding a new data reader</a><ul>
<li><a class="reference internal" href="#the-format">The Format</a></li>
<li><a class="reference internal" href="#the-code">The Code</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div>
  </body>
</html>